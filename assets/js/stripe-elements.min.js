jQuery(function(e){"use strict";e("form.checkout, form#order_review").on("change",'input[name="wc-stripe-payment-token"]',function(){"new"===e('.stripe-legacy-payment-fields input[name="wc-stripe-payment-token"]:checked').val()?e(".stripe-legacy-payment-fields #stripe-payment-data").slideDown(200):e(".stripe-legacy-payment-fields #stripe-payment-data").slideUp(200)});var r,t=Stripe(wc_stripe_params.key),o=t.elements(),a={getAjaxURL:function(e){return wc_stripe_params.ajaxurl.toString().replace("%%endpoint%%","wc_stripe_"+e)},init:function(){e("form.woocommerce-checkout").length&&(this.form=e("form.woocommerce-checkout")),e("form.woocommerce-checkout").on("checkout_place_order_stripe checkout_place_order_stripe_bancontact checkout_place_order_stripe_sofort checkout_place_order_stripe_giropay checkout_place_order_stripe_ideal checkout_place_order_stripe_alipay checkout_place_order_stripe_sepa",this.onSubmit),e("form#order_review").length&&(this.form=e("form#order_review")),e("form#order_review").on("submit",this.onSubmit),e("form#add_payment_method").length&&(this.form=e("form#add_payment_method")),e("form#add_payment_method").on("submit",this.onSubmit),e("form.woocommerce-checkout").on("change","#stripe-bank-country",this.reset),e(document).on("stripeError",this.onError).on("checkout_error",this.reset);var t={base:{iconColor:"#666EE8",color:"#31325F",lineHeight:"50px",fontSize:"15px","::placeholder":{color:"#CFD7E0"}}};(r=o.create("card",{style:t,hidePostalCode:!0})).addEventListener("change",function(r){a.onCCFormChange(),r.error&&e(document.body).trigger("stripeError",r)}),wc_stripe_params.is_checkout?e(document.body).on("updated_checkout",function(){r&&r.unmount("#stripe-card-element"),r.mount("#stripe-card-element")}):(e("form#add_payment_method").length||e("form#order_review").length)&&r.mount("#stripe-card-element")},isStripeChosen:function(){return e("#payment_method_stripe, #payment_method_stripe_bancontact, #payment_method_stripe_sofort, #payment_method_stripe_giropay, #payment_method_stripe_ideal, #payment_method_stripe_alipay, #payment_method_stripe_sepa").is(":checked")||"new"===e('input[name="wc-stripe-payment-token"]:checked').val()},isStripeSaveCardChosen:function(){return e("#payment_method_stripe").is(":checked")&&"new"!==e('input[name="wc-stripe-payment-token"]:checked').val()},isStripeCardChosen:function(){return e("#payment_method_stripe").is(":checked")},isBancontactChosen:function(){return e("#payment_method_stripe_bancontact").is(":checked")},isGiropayChosen:function(){return e("#payment_method_stripe_giropay").is(":checked")},isIdealChosen:function(){return e("#payment_method_stripe_ideal").is(":checked")},isSofortChosen:function(){return e("#payment_method_stripe_sofort").is(":checked")},isAlipayChosen:function(){return e("#payment_method_stripe_alipay").is(":checked")},isSepaChosen:function(){return e("#payment_method_stripe_sepa").is(":checked")},hasSource:function(){return 0<e("input.stripe-source").length},isMobile:function(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},block:function(){a.isMobile()?e.blockUI({message:null,overlayCSS:{background:"#fff",opacity:.6}}):a.form.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){a.isMobile()?e.unblockUI():a.form.unblock()},getSelectedPaymentElement:function(){return e('.wc_payment_methods input[name="payment_method"]:checked')},onError:function(r,t){var o=t.error.message,i=a.getSelectedPaymentElement().parent(".wc_payment_method").find(".stripe-source-errors");"invalid_request_error"!==t.error.type&&"api_connection_error"!==t.error.type&&"api_error"!==t.error.type&&"authentication_error"!==t.error.type&&"rate_limit_error"!==t.error.type||(o=wc_stripe_params.invalid_request_error),"card_error"===t.error.type&&wc_stripe_params.hasOwnProperty(t.error.code)&&(o=wc_stripe_params[t.error.code]),a.reset(),console.log(t.error.message),e(i).html('<ul class="woocommerce_error woocommerce-error wc-stripe-error"><li>'+o+"</li></ul>"),a.unblock()},getOwnerDetails:function(){var r=e("#billing_first_name").length?e("#billing_first_name").val():wc_stripe_params.billing_first_name,t=e("#billing_last_name").length?e("#billing_last_name").val():wc_stripe_params.billing_last_name,o={owner:{name:"",address:{},email:"",phone:""}};return o.owner.name=r,r&&t&&(o.owner.name=r+" "+t),o.owner.email=e("#billing_email").val(),o.owner.phone=e("#billing_phone").val(),e("#billing_address_1").length>0?(o.owner.address.line1=e("#billing_address_1").val(),o.owner.address.line2=e("#billing_address_2").val(),o.owner.address.state=e("#billing_state").val(),o.owner.address.city=e("#billing_city").val(),o.owner.address.postal_code=e("#billing_postcode").val(),o.owner.address.country=e("#billing_country").val()):wc_stripe_params.billing_address_1&&(o.owner.address.line1=wc_stripe_params.billing_address_1,o.owner.address.line2=wc_stripe_params.billing_address_2,o.owner.address.state=wc_stripe_params.billing_state,o.owner.address.city=wc_stripe_params.billing_city,o.owner.address.postal_code=wc_stripe_params.billing_postcode,o.owner.address.country=wc_stripe_params.billing_country),o},createSource:function(){var o=a.getOwnerDetails(),i="card";if(a.isSepaChosen()&&(i="sepa_debit"),"card"===i)t.createSource(r,o).then(a.sourceResponse);else{switch(i){case"bancontact":case"giropay":case"ideal":case"sofort":case"alipay":o.amount=e("#stripe-"+i+"-payment-data").data("amount"),o.currency=e("#stripe-"+i+"-payment-data").data("currency"),o.redirect={return_url:wc_stripe_params.return_url},"bancontact"===i&&(o.bancontact={statement_descriptor:wc_stripe_params.statement_descriptor}),"giropay"===i&&(o.giropay={statement_descriptor:wc_stripe_params.statement_descriptor}),"ideal"===i&&(o.ideal={statement_descriptor:wc_stripe_params.statement_descriptor}),"sofort"===i&&(o.sofort={statement_descriptor:wc_stripe_params.statement_descriptor})}switch(i){case"sepa_debit":o.currency=e("#stripe-"+i+"-payment-data").data("currency"),o.sepa_debit={iban:e("#stripe-sepa-iban").val()};break;case"ideal":o.ideal={bank:e("#stripe-ideal-bank").val()};break;case"sofort":o.sofort={country:e("#stripe-sofort-country").val()};break;case"bitcoin":case"alipay":o.currency=e("#stripe-"+i+"-payment-data").data("currency"),o.amount=e("#stripe-"+i+"-payment-data").data("amount")}o.type=i,t.createSource(o).then(a.sourceResponse)}},sourceResponse:function(r){r.error?e(document.body).trigger("stripeError",r):"no"===wc_stripe_params.allow_prepaid_card&&"card"===r.source.type&&"prepaid"===r.source.card.funding?(r.error={message:wc_stripe_params.no_prepaid_card_msg},e(document.body).trigger("stripeError",r)):a.processStripeResponse(r.source)},onSubmit:function(r){if(a.isStripeChosen()&&!a.isStripeSaveCardChosen()&&!a.hasSource()){if(r.preventDefault(),a.block(),a.isBancontactChosen())return!0;if(a.isGiropayChosen())return!0;if(a.isIdealChosen())return!0;if(a.isAlipayChosen())return!0;if(a.isSofortChosen()){if("-1"===e("#stripe-bank-country").val()){var t={error:{message:wc_stripe_params.no_bank_country_msg}};return e(document.body).trigger("stripeError",t),!1}return!0}if(a.isSepaChosen()){if(""===e("#stripe-sepa-iban").val()){var o={error:{message:wc_stripe_params.no_iban_msg}};return e(document.body).trigger("stripeError",o),!1}a.validateCheckout()}return a.validateCheckout(),!1}},onCCFormChange:function(){a.reset()},processStripeResponse:function(e){a.reset(),a.form.append("<input type='hidden' class='stripe-source' name='stripe_source' value='"+e.id+"'/>"),a.form.append("<input type='hidden' class='stripe-source' name='stripe_source_object' value='"+JSON.stringify(e)+"'/>"),a.form.submit()},reset:function(){e(".wc-stripe-error, .stripe-source ").remove()},getRequiredFields:function(){return a.form.find(".form-row.validate-required > input, .form-row.validate-required > select")},validateCheckout:function(){var r={nonce:wc_stripe_params.stripe_nonce,required_fields:a.getRequiredFields().serialize(),all_fields:a.form.serialize(),source_type:a.getSelectedPaymentElement().val()};e.ajax({type:"POST",url:a.getAjaxURL("validate_checkout"),data:r,dataType:"json",success:function(e){"success"===e?a.createSource():e.messages&&(a.reset(),a.submitError(e.messages))}})},submitError:function(r){e(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),a.form.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+r+"</div>"),a.form.removeClass("processing").unblock(),a.form.find(".input-text, select, input:checkbox").blur(),e("html, body").animate({scrollTop:e("form.checkout").offset().top-100},1e3),e(document.body).trigger("checkout_error")}};a.init()});